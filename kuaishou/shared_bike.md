## 🚲 整体流程图概览：

```
用户手机App -> 扫码 -> App请求后台服务器 -> 验证/授权 -> 服务器通知单车 -> 单车开锁
                                            ↘
                                         本地蓝牙（部分品牌）
```

---

## ✅ 步骤详解：

### 1. **用户扫码**

* 用户打开共享单车 App（如哈啰、美团、青桔）
* 扫描车身上的二维码（包含单车的唯一编号或设备ID）

### 2. **App 向服务器发起开锁请求**

* App 把二维码信息（如设备编号）+ 用户身份 + 地理位置 一起发送到 **共享单车后台服务器**
* HTTPs 请求，一般为 POST，携带身份令牌（如 JWT）

### 3. **服务器端验证权限**

* 验证用户是否实名 / 是否有余额 / 是否有正在骑的订单
* 如果通过，系统生成开锁指令，继续下一步

### 4. **发送开锁命令**

#### ✅ 两种常见方式：

#### 🔹 方式一：**通过蜂窝网络（2G/4G/NB-IoT）**

* 服务器将开锁命令通过物联网通信平台（MQTT 或 TCP）推送给单车终端
* 单车终端的 MCU 控制电机执行“开锁”
* 车锁通过蜂窝网络回传“开锁成功”状态

#### 🔹 方式二：**通过蓝牙直接开锁（常用于无蜂窝网的车）**

* App 与车身蓝牙直接建立连接（蓝牙广播中包含设备ID）
* App 生成一次性密钥 / 开锁令牌，与车身进行握手验证
* 蓝牙写入指令给 MCU，控制开锁电机

> 一些品牌（如美团）使用蓝牙+加密通信完成本地快速开锁，提高速度，提升用户体验。

---

### 5. **上报开锁成功 & 开启骑行订单**

* 单车端（或App）通知服务器：开锁成功
* 服务器创建骑行订单，开始计费

---

### 6. **骑行过程中**

* 单车通过内置 GPS + 移动通信模块周期性上报位置（有些支持 NB-IoT）
* App 显示地图/路径，后台用于防盗和调度分析

---

### 7. **还车 + 关锁 + 支付**

* 用户到达目的地关锁（手动或自动）
* 车锁检测锁定状态，回传服务器
* 服务器计算费用并结束订单，用户完成支付

---

## 🧠 关键技术组件

| 模块    | 技术                                   |
| ----- | ------------------------------------ |
| App扫码 | 摄像头 + 二维码识别                          |
| 通信    | HTTPS, 蓝牙BLE, MQTT, TCP              |
| 硬件    | MCU + 电磁锁/电机 + GPS + 通信模组（NB-IoT/2G） |
| 安全    | AES加密、Token鉴权、TLS                    |

---

> “共享单车扫码开锁的核心流程是用户通过App扫码发起请求，服务器验证后将开锁命令下发给车锁设备（通过蜂窝或蓝牙），单车控制模块接收到后执行电机操作开锁，并上报结果。整体流程涉及扫码识别、网络通信、IoT控制、安全加密等关键技术。”

---
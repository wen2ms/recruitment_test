TCP（Transmission Control Protocol，传输控制协议）的**流量控制（Flow Control）**是一种**端到端机制**，目的是防止**发送方发送数据过快**，以致于**接收方来不及处理**，从而导致数据丢失。流量控制的核心是基于**接收方的处理能力进行速率调节**。

---

### 🔧 流量控制的关键机制：**滑动窗口协议**

TCP使用的是**滑动窗口（Sliding Window）协议**来实现流量控制。

#### 🧠 核心思想：

* 每个TCP连接的接收方会告知发送方它当前还能接收多少字节的数据（称为**接收窗口大小（rwnd，receive window）**）。
* 发送方根据这个接收窗口大小决定可以发送多少数据。

---

### 📦 示例说明

假设：

* 接收方的缓存区总大小是 **1000 字节**；
* 当前已经接收了 700 字节还没处理；
* 那么剩余可用空间是 300 字节；
* 接收方会在 TCP ACK 报文中告诉发送方：**rwnd = 300**；
* 发送方就不会再发超过 300 字节的数据，直到收到接收方新的窗口更新。

---

### 🧮 滑动窗口的三个变量：

| 名称             | 描述                                         |
| -------------- | ------------------------------------------ |
| **发送窗口（swnd）** | 发送方允许发送的数据范围，由接收方提供的 rwnd 控制               |
| **接收窗口（rwnd）** | 接收方的缓冲区大小，通知给发送方                           |
| **拥塞窗口（cwnd）** | 与流量控制无关，是 TCP 拥塞控制的一部分（但与发送窗口联合决定实际能发多少数据） |

---

### 🛑 如果接收方 rwnd = 0？

* 表示接收方暂时处理不过来了，告诉发送方“暂停发送”。
* 此时发送方会进入\*\*持续计时器（Persist Timer）\*\*状态，定期发送一个 1 字节的探测包，确认接收窗口是否恢复。

---

### ✅ 总结一张图理解（概念层）：

```
       +-------------+                      +-------------+
       |   发送方    |=====================>|   接收方    |
       |（发送数据） |<=======窗口大小=======|（rwnd 告知）|
       +-------------+                      +-------------+
```

## 📦 ACK 报文中包含 `SEQ + ACK + rwnd` 的时机

### 1. **正常数据接收后：**

* 每当接收方收到数据，并准备好下一块缓冲区时，会发送 ACK。
* ACK 报文中带：

  * `ack = 下一个期望的序号`
  * `rwnd = 当前剩余可接收窗口大小`

🔁 **目的**：告诉发送方：哪些数据收到了，还能发多少。

---

### 2. **窗口大小发生变化时（rwnd 变化）：**

* 如果接收方的缓冲区腾出空间（比如应用程序读取了数据），`rwnd` 增大：

  * 即使没有新数据，也可能会发送一个 ACK（或称 **window update**），告诉发送方可以恢复发送。

---

### 3. **窗口为 0 后恢复时（rwnd 从 0 变非0）：**

* 如果接收方之前告诉发送方 “窗口为 0”（`rwnd = 0`），发送方会停止发送数据。
* 一旦窗口恢复（腾出空间），接收方**必须发送一个“窗口更新”包**（ACK + 新的 `rwnd`），告诉发送方可以继续传了。

📌 **这一步极其重要，否则发送方会陷入“零窗口阻塞”状态**。

---

### 4. **重复 ACK 或窗口探测（窗口探测包）之后：**

* 如果发送方收到 `rwnd=0`，它会发送所谓的 **零窗口探测包**（一个字节或空包）。
* 接收方收到后，即使窗口仍为 0，也会 ACK 并携带最新 `rwnd` 值。

---

## 🧠 小结：

| 触发时机         | 会发送 SEQ+ACK+rwnd 的情况  |
| ------------ | --------------------- |
| 收到数据         | ACK 新的序列号，附带当前 `rwnd` |
| 窗口大小改变       | 发送窗口更新包，更新 `rwnd`     |
| rwnd 从 0 变非0 | 必须主动 ACK 告诉发送方可以恢复发送  |
| 接收到窗口探测      | 发送 ACK 包含当前 `rwnd`    |

---
è¿™æ˜¯ä¸ªéå¸¸å…³é”®çš„é—®é¢˜ï¼š**æ™ºèƒ½æŒ‡é’ˆå¹¶ä¸æ˜¯ä¸‡èƒ½çš„ï¼Œå®ƒèƒ½å‡å°‘å†…å­˜æ³„æ¼ï¼Œä½†ç”¨é”™äº†ä¾ç„¶ä¼šé€ æˆå†…å­˜æ³„æ¼ï¼**

---

## âœ… æ™ºèƒ½æŒ‡é’ˆèƒ½åšä»€ä¹ˆï¼Ÿ

* è‡ªåŠ¨é‡Šæ”¾èµ„æºï¼ˆé€šè¿‡ææ„å‡½æ•°ï¼‰
* é¿å…æ‰‹åŠ¨ `delete`
* å‡å°‘å†…å­˜æ³„æ¼é£é™©

---

## âš ï¸ ä½†æ™ºèƒ½æŒ‡é’ˆæœ¬èº«ä¸èƒ½æœç»å†…å­˜æ³„æ¼ï¼Œå¸¸è§**å¯¼è‡´æ³„æ¼çš„åŸå› å¦‚ä¸‹ï¼š**

---

### ğŸ§¨ 1. **å¾ªç¯å¼•ç”¨ï¼ˆshared\_ptr ä¸ shared\_ptrï¼‰**

```cpp
struct B;
struct A {
    std::shared_ptr<B> b;
};

struct B {
    std::shared_ptr<A> a;
};

void leak() {
    auto a = std::make_shared<A>();
    auto b = std::make_shared<B>();
    a->b = b;
    b->a = a;  // âŒ å¾ªç¯å¼•ç”¨ï¼šä¸¤ä¸ª shared_ptr å¼•ç”¨å¯¹æ–¹ï¼Œå¼•ç”¨è®¡æ•°æ°¸è¿œä¸ä¸º 0
}
```

* `a` å¼•ç”¨ `b`ï¼Œ`b` åˆå¼•ç”¨ `a`ï¼Œå³ä½¿å‡ºäº†ä½œç”¨åŸŸï¼Œä¹Ÿä¸ä¼šé‡Šæ”¾å†…å­˜ã€‚
* **è§£å†³æ–¹æ³•ï¼šä½¿ç”¨ `std::weak_ptr` æ‰“ç ´ç¯**

```cpp
struct B;
struct A {
    std::shared_ptr<B> b;
};

struct B {
    std::weak_ptr<A> a;  // âœ… ä½¿ç”¨ weak_ptr æ‰“ç ´ç¯
};
```

---

### ğŸ§¨ 2. **æŠŠè£¸æŒ‡é’ˆäº¤ç»™å¤šä¸ª `unique_ptr` ç®¡ç†**

```cpp
int* p = new int(10);
std::unique_ptr<int> p1(p);
std::unique_ptr<int> p2(p);  // âŒ ä¸¤ä¸ª unique_ptr ç®¡ç†åŒä¸€å—å†…å­˜ â†’ double delete or leak
```

* `unique_ptr` æ˜¯ç‹¬å çš„ï¼Œä¸å…è®¸å¤šä¸ªæŒ‡é’ˆç®¡ç†åŒä¸€å†…å­˜
* æ­£ç¡®åšæ³•ï¼šåªèƒ½æœ‰ä¸€ä¸ª `unique_ptr` æˆ–ç”¨ `shared_ptr` ç®¡ç†å…±äº«å¯¹è±¡

---

### ğŸ§¨ 3. **ä»æ™ºèƒ½æŒ‡é’ˆä¸­æ³„æ¼è£¸æŒ‡é’ˆ**

```cpp
std::shared_ptr<int> sp = std::make_shared<int>(10);
int* raw = sp.get();  // âŒ å¦‚æœä½ æŠŠ raw å‚¨å­˜å¹¶æ‰‹åŠ¨ deleteï¼Œå°±ä¼šå‡ºé—®é¢˜
```

* ä½¿ç”¨ `.get()` æ‹¿è£¸æŒ‡é’ˆæ˜¯å…è®¸çš„ï¼Œä½†ä½ **ä¸èƒ½ delete è¿™ä¸ªæŒ‡é’ˆ**ï¼Œå¦åˆ™ä¼š double deleteã€‚
* æ›´ç³Ÿç³•çš„æ˜¯ä½ ä¿å­˜äº†è£¸æŒ‡é’ˆä½†ä¸ä¿å­˜ `shared_ptr`ï¼Œå¯¹è±¡å¯èƒ½ä¼šè¢«æå‰é‡Šæ”¾ã€‚

---

### ğŸ§¨ 4. **æ™ºèƒ½æŒ‡é’ˆç®¡ç†ä¸å½“çš„æ•°ç»„**

```cpp
std::shared_ptr<int> arr(new int[10]);  // âŒ shared_ptr é»˜è®¤è°ƒç”¨ deleteï¼Œä¸ä¼šè°ƒç”¨ delete[]
```

* ä¼šè°ƒç”¨ `delete` è€Œä¸æ˜¯ `delete[]`ï¼Œå¯¼è‡´æœªå®šä¹‰è¡Œä¸ºã€‚
* æ­£ç¡®åšæ³•ï¼š

```cpp
std::shared_ptr<int> arr(new int[10], std::default_delete<int[]>());  // âœ… æŒ‡å®šåˆ é™¤å™¨
```

---

### ğŸ§¨ 5. **èµ„æºé€ƒé€¸ï¼Œå¼•ç”¨è®¡æ•°å¤–æœªé‡Šæ”¾**

```cpp
std::shared_ptr<MyClass> p = std::make_shared<MyClass>();
globalRaw = p.get();  // âŒ æŒ‡é’ˆé€ƒé€¸ï¼Œp é”€æ¯å globalRaw å˜æ‚¬ç©ºæŒ‡é’ˆ
```

* èµ„æºåœ¨å…±äº«æŒ‡é’ˆé‡Šæ”¾åï¼Œè¿˜è¢«å…¶ä»–ä»£ç ä½¿ç”¨ â†’ æ‚¬ç©ºè®¿é—®æˆ–å†…å­˜æ³„æ¼

---

## âœ… æ€»ç»“ï¼šé¿å…æ™ºèƒ½æŒ‡é’ˆå¯¼è‡´çš„å†…å­˜æ³„æ¼

| åŸå›                      | é¿å…æ–¹æ³•                                |
| ---------------------- | ----------------------------------- |
| å¾ªç¯å¼•ç”¨                   | ç”¨ `weak_ptr` æ‰“ç ´                     |
| å¤šä¸ª `unique_ptr` ç®¡ç†åŒä¸€æŒ‡é’ˆ | ä¸¥æ ¼ç‹¬å ï¼Œåªèµ‹å€¼ä¸€æ¬¡                          |
| è£¸æŒ‡é’ˆé€ƒé€¸                  | å°½é‡ä¸è¦ä½¿ç”¨ `.get()`ï¼Œæˆ–è€…åªä¸´æ—¶ç”¨              |
| é”™è¯¯åˆ é™¤å™¨                  | `shared_ptr<T[]>` è¦é…è‡ªå®šä¹‰åˆ é™¤å™¨          |
| ä¸è¯¥å…±äº«çš„èµ„æºè¢«å…±äº«             | åŒºåˆ† `unique_ptr` å’Œ `shared_ptr` ä½¿ç”¨åœºæ™¯ |

---

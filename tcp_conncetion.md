好的，我们来分别讲解 **TCP 三次握手（连接建立）** 和 **TCP 四次挥手（连接断开）** 的完整过程，结合示意和状态说明，便于你理解。

---

## ✅ 一、TCP 三次握手（建立连接）

**目的**：建立连接，双方确认通信能力，初始化序列号等。

### 👉 过程示意：

```
客户端（Client）                          服务端（Server）

    | --------- SYN seq=x ----------> |
    |                                 |
    | <----- SYN seq=y, ACK ack=x+1-- |
    |                                 |
    | --------- ACK ack=y+1 --------> |
```

### 📌 步骤详解：

1. **第一次握手（客户端 -> 服务端）**

   * 客户端发送 `SYN` 报文（同步序列号），进入 `SYN_SENT` 状态。
   * 报文中包含初始序列号 `seq = x`。

2. **第二次握手（服务端 -> 客户端）**

   * 服务端收到 `SYN`，返回一个 `SYN + ACK` 报文。
   * `seq = y`（服务端初始序列号），`ack = x + 1`。
   * 进入 `SYN_RECEIVED` 状态。

3. **第三次握手（客户端 -> 服务端）**

   * 客户端收到 `SYN + ACK`，再发送一个 `ACK` 报文。
   * `ack = y + 1`。
   * 客户端进入 `ESTABLISHED` 状态，服务端收到后也进入 `ESTABLISHED`。

✅ **连接建立完成！**

---

## ✅ 二、TCP 四次挥手（断开连接）

**目的**：双方独立关闭各自的发送方向，确保数据完整传输。

### 👉 过程示意：

```
客户端（Client）                          服务端（Server）

    | --------- FIN seq=u ----------> |
    |                                 |
    | <---------- ACK ack=u+1 ------- |
    |                                 |
    | <--------- FIN seq=v ---------- |
    |                                 |
    | ----------- ACK ack=v+1 ------> |
```

### 📌 步骤详解：

1. **第一次挥手（客户端 -> 服务端）**

   * 客户端发送 `FIN` 报文，表示数据发送完毕，不再发送。
   * 进入 `FIN_WAIT_1` 状态。

2. **第二次挥手（服务端 -> 客户端）**

   * 服务端收到 `FIN`，返回 `ACK`，表示确认。
   * 进入 `CLOSE_WAIT` 状态。
   * 客户端收到 ACK，进入 `FIN_WAIT_2` 状态。

3. **第三次挥手（服务端 -> 客户端）**

   * 服务端也不再发送数据，发送 `FIN` 报文。
   * 进入 `LAST_ACK` 状态。

4. **第四次挥手（客户端 -> 服务端）**

   * 客户端收到 `FIN`，发送 `ACK`，进入 `TIME_WAIT` 状态（等待 2MSL 时间，确保 ACK 到达）。
   * 服务端收到后关闭连接。
   * 客户端等待完 `TIME_WAIT` 后也关闭连接。

✅ **连接断开完成！**

---

## 🔄 三次握手 vs 四次挥手对比总结

| 项目     | 三次握手                       | 四次挥手                        |
| ------ | -------------------------- | --------------------------- |
| 阶段     | 建立连接                       | 断开连接                        |
| 次数     | 3 次报文                      | 4 次报文                       |
| 报文类型   | SYN，ACK                    | FIN，ACK                     |
| 双方状态变更 | 同时建立连接                     | 各自独立关闭发送方向                  |
| 重要状态   | `SYN_SENT`, `SYN_RECEIVED` | `FIN_WAIT_1/2`, `TIME_WAIT` |
| 是否可合并  | 不可以                        | ACK + FIN 可能合并（变成3报文）       |

---


### ❌ 四次挥手能否改成三次？

理论上讲 **不能**，因为：

* 发送 FIN 和接收 FIN 是两个独立的操作，可能发生在不同时间。
* 如果合并 ACK 和 FIN 成一个包（让 服务端 在第 2 步同时发送 ACK 和 FIN），就假设了 服务端 立刻准备好关闭，这不总是成立。

**例外情况：**

* 如果服务端没有数据要发送，确实可以在 **第 2 步** 把 ACK 和 FIN 合并（即第二步变成“ACK + FIN”），
* 这样 **实际只有三次报文交换**，但本质上还是四个步骤，只是报文合并了。

所以我们可以说：

> **实际的报文可能是三次发送，但逻辑上仍是四次挥手。**

---

### ✅ 总结

* TCP 四次挥手是为了支持**双向的独立关闭**。
* **不能彻底改成三次**，但在某些情况下可以合并报文使得只发送三次。
* 这是 TCP 可靠性和灵活性的一部分设计。
